#!/usr/bin/env python
# -*- coding: utf-8 -*-
from __future__ import print_function
import json
import sys
from sklearn import tree

from dump_apk_feature import get_apk_feature_apk, get_apk_feature_json


def _training_data():
    feature_vec = []
    labels = []
    with open("malware_data.txt") as fr:
        arr = json.load(fr)
        feature_vec.extend(arr)
        labels.extend([1] * len(arr))
    with open("non_malwares.txt") as fr:
        arr = json.load(fr)
        feature_vec.extend(arr)
        labels.extend([0] * len(arr))
    return feature_vec, labels


def classify(filename):
    feature_vec = []
    if filename.endswith("apk"):
        feature_vec = get_apk_feature_apk(filename)
    else:
        feature_vec = get_apk_feature_json(filename)
    clf = tree.DecisionTreeClassifier()
    feature_vecs, labels = _training_data()
    clf.fit(feature_vecs, labels)
    return clf.predict([feature_vec])[0]


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("usage: %s <filename>" % sys.argv[0], file=sys.stderr)
    filename = sys.argv[1]
    if classify(filename):
        print("Malware")
    else:
        print("NonMalware")
